name: Example - Ephemeral Cluster Testing

# This is an example workflow demonstrating how to use ephemeral clusters for testing
# Copy this to your application repository and modify as needed

on:
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  TERRAFORM_INFRA_REPO: 'your-org/terraform-infra'
  HELM_CD_REPO: 'your-org/helm-cd'
  GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}

jobs:
  create-cluster:
    name: Create Ephemeral GKE Cluster
    uses: your-org/terraform-infra/.github/workflows/create-ephemeral-cluster.yml@main
    with:
      cluster_identifier: pr-${{ github.event.pull_request.number || github.run_number }}
      terraform_version: '1.5.0'
      machine_type: 'e2-medium'
      min_nodes: 1
      max_nodes: 3
      region: 'us-central1'
      zone: 'us-central1-a'
      enable_bastion: false
    secrets: inherit

  bootstrap-flux:
    name: Bootstrap FluxCD
    needs: create-cluster
    uses: your-org/helm-cd/.github/workflows/bootstrap-flux-ephemeral.yml@main
    with:
      cluster_name: ${{ needs.create-cluster.outputs.cluster_name }}
      cluster_location: ${{ needs.create-cluster.outputs.cluster_location }}
      gcp_project_id: ${{ vars.GCP_PROJECT_ID }}
      flux_path: './clusters/ephemeral'
      flux_branch: 'main'
      app_namespace: 'ephemeral'
    secrets:
      GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
      FLUX_GITHUB_TOKEN: ${{ secrets.FLUX_GITHUB_TOKEN }}

  run-tests:
    name: Run Integration Tests
    needs: [create-cluster, bootstrap-flux]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ vars.GCP_PROJECT_ID }}

      - name: Install gke-gcloud-auth-plugin
        run: |
          gcloud components install gke-gcloud-auth-plugin

      - name: Get GKE Credentials
        run: |
          gcloud container clusters get-credentials ${{ needs.create-cluster.outputs.cluster_name }} \
            --region ${{ needs.create-cluster.outputs.cluster_location }} \
            --project ${{ vars.GCP_PROJECT_ID }}

      - name: Verify Cluster Access
        run: |
          kubectl cluster-info
          kubectl get nodes
          kubectl get pods --all-namespaces

      - name: Wait for Application to be Ready
        run: |
          echo "Waiting for application to be fully ready..."
          kubectl wait --for=condition=ready pod \
            --selector=app.kubernetes.io/name=nginx \
            --namespace=ephemeral \
            --timeout=300s

      - name: Get Ingress IP
        id: ingress
        run: |
          INGRESS_IP=$(kubectl get svc istio-ingressgateway \
            -n istio-system \
            -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
          echo "ip=${INGRESS_IP}" >> $GITHUB_OUTPUT
          echo "Ingress IP: ${INGRESS_IP}"

      - name: Run Smoke Tests
        run: |
          INGRESS_IP=${{ steps.ingress.outputs.ip }}

          echo "Running smoke tests against ${INGRESS_IP}..."

          # Test 1: Health check
          echo "Test 1: Health check"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Host: test.example.com" \
            http://${INGRESS_IP}/)

          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "✓ Health check passed (HTTP $HTTP_CODE)"
          else
            echo "✗ Health check failed (HTTP $HTTP_CODE)"
            exit 1
          fi

          # Test 2: Response content check
          echo "Test 2: Response content"
          RESPONSE=$(curl -s -H "Host: test.example.com" http://${INGRESS_IP}/)

          if echo "$RESPONSE" | grep -q "Welcome to nginx"; then
            echo "✓ Response content valid"
          else
            echo "✗ Response content invalid"
            exit 1
          fi

          echo "✓ All smoke tests passed"

      - name: Run Integration Tests
        run: |
          echo "Running integration tests..."

          # Add your custom integration tests here
          # Examples:
          # - API endpoint tests
          # - Database connectivity tests
          # - Third-party service integration tests
          # - Performance tests

          echo "✓ Integration tests passed"

      - name: Run Load Tests (Optional)
        if: false  # Enable by changing to true
        run: |
          INGRESS_IP=${{ steps.ingress.outputs.ip }}

          echo "Running load tests..."

          # Install k6 or other load testing tools
          # Example with curl in a loop:
          for i in {1..100}; do
            curl -s -H "Host: test.example.com" http://${INGRESS_IP}/ > /dev/null
            echo "Request $i completed"
          done

          echo "✓ Load tests completed"

      - name: Collect Logs on Failure
        if: failure()
        run: |
          echo "Collecting diagnostic information..."

          echo "=== Pods in ephemeral namespace ==="
          kubectl get pods -n ephemeral -o wide

          echo "=== Pod logs ==="
          kubectl logs -n ephemeral --all-containers --tail=100 \
            --selector=app.kubernetes.io/name=nginx || true

          echo "=== Istio ingress gateway logs ==="
          kubectl logs -n istio-system --tail=100 \
            --selector=app=istio-ingressgateway || true

          echo "=== FluxCD reconciliation status ==="
          kubectl get kustomizations -n flux-system || true
          kubectl get helmreleases -n flux-system || true

      - name: Test Summary
        if: always()
        run: |
          echo "### Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Cluster:** \`${{ needs.create-cluster.outputs.cluster_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Ingress IP:** \`${{ steps.ingress.outputs.ip }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY

  cleanup:
    name: Cleanup Ephemeral Cluster
    needs: [create-cluster, run-tests]
    if: always()
    uses: your-org/terraform-infra/.github/workflows/destroy-ephemeral-cluster.yml@main
    with:
      cluster_identifier: pr-${{ github.event.pull_request.number || github.run_number }}
      terraform_version: '1.5.0'
      region: 'us-central1'
    secrets: inherit
